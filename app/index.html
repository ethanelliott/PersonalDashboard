<html>

<head>
	<!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">-->
	<link href="http://fonts.googleapis.com/css?family=Roboto:400,100,300,500,700,900,400italic,700italic,300italic" rel="stylesheet" type="text/css" media="screen" />
	<link href="http://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.5.1/fullcalendar.min.css" rel="stylesheet" type="text/css" media="screen" />
	<link href="../app/fa/css/font-awesome.css" rel="stylesheet" type="text/css" media="screen" />
	<link href="style.css" rel="stylesheet" type="text/css" media="screen" />
	<script>
		if (typeof module === 'object') {
			window.module = module;
			module = undefined;
		}
	</script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://momentjs.com/downloads/moment.min.js"></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.1.0/fullcalendar.js'></script>
	<script src="jquery.countdown.min.js"></script>
	<script>
		if (window.module) module = window.module;
	</script>
</head>

<body>
	<div class="titlebar">
		<div class="title-wrapper">
			<i class="fa fa-graduation-cap" aria-hidden="true" style="font-size:2em;margin-right:0.5em;"></i>
			<span class="window-title"></span>
		</div>
		<div id="time"></div>
		<div class="action-buttons-wrapper">
			<button id="close-btn">X</button>
			<button id="min-btn"><i class="fa fa-window-minimize" aria-hidden="true"></i></button>
			<button id="max-btn"><i class="fa fa-window-restore" aria-hidden="true"></i></button>
			<button id="full-btn"><i class="fa fa-arrows-alt" aria-hidden="true"></i></button>
			<button id="dev-btn" class="hidden"><i class="fa fa-cogs" aria-hidden="true"></i></button>
		</div>
	</div>
	<div class="content-wrapper">
		<div id="markTable" class="modal">
			<div class="modal-content">
				<div class="container">
					<div style="width:100%;display:flex;justify-content:space-between;align-items:center; flex-direction:row;">
						<h1>Add / Edit Marks</h1>
						<i class="table-add fa fa-plus"></i>
					</div>
					<div id="mark-table" class="table-editable">
						<table class="table">
							<tr class="hide">
								<td contenteditable="true"></td>
								<td contenteditable="true"></td>
								<td contenteditable="true"></td>
								<td style="text-align: center;">
									<i class="table-remove fa fa-times" onclick="$(this).parents('tr').detach();"></i>
								</td>
							</tr>
							<tr>
								<th>Assignment/Mark Name</th>
								<th>Weight (%)</th>
								<th>Score (%)</th>
								<th>Del</th>
							</tr>
						</table>
					</div>
					<div style="display:flex;justify-content:flex-end; flex-direction:row;margin-top:2vh;">
						<button id="mark-save-btn" style="width:100px;margin-right:2vw;" class="button" type="button">Save</button>
						<button id="mark-cancel-btn" style="width:100px;margin-right:2vw;" class="button" type="button">Cancel</button>
					</div>
					<script>
						let $TABLE = $('#mark-table');

						$('.table-add').click(() => {
							var $clone = $TABLE.find('tr.hide').clone(true).removeClass('hide table-line');
							$TABLE.find('table').append($clone);
						});

						document.querySelectorAll('.table-remove').forEach(() => {
							console.log(this);
						});

						jQuery.fn.pop = [].pop;
						jQuery.fn.shift = [].shift;
					</script>
				</div>
			</div>
		</div>
		<div id="mainContentModal" class="modal">
			<div class="modal-content">
				<h1>Are you sure you want to delete this?</h1>
				<h2>This cannot be undone...</h2>
				<div style="display:flex;justify-content:flex-end; flex-direction:row;">
					<button id="modal-confirm-btn" style="width:100px;margin-right:2vw;" class="button" type="button">Yes</button>
					<button id="modal-cancel-btn" style="width:100px;margin-right:2vw;" class="button" type="button">Cancel</button>
				</div>
			</div>
		</div>
		<div class="left-pannel">

		</div>
		<div class="right-pannel">
			<div id="pannel-content-wrapper">

			</div>
		</div>
	</div>
	<script>
		const dev = false;
		const electron = require('electron');
		const {
			remote
		} = electron;
		const dialog = remote.dialog;
		const fs = require('fs');
		const path = require('path')
		const url = require('url');
		const request = require('request-ssl');
		const cheerio = require('cheerio');
		const crypto = require('crypto');
		const mkdirp = require('mkdirp')

		var jqMenuList = [];
		var menuListContent = [];
		var screenUpdateInterval;

		function colorFade(col, amt) {
			var usePound = false;
			if (col[0] == "#") {
				col = col.slice(1);
				usePound = true;
			}
			var num = parseInt(col, 16);
			var r = (num >> 16) + amt;
			if (r > 255) r = 255;
			else if (r < 0) r = 0;
			var b = ((num >> 8) & 0x00FF) + amt;
			if (b > 255) b = 255;
			else if (b < 0) b = 0;
			var g = (num & 0x0000FF) + amt;
			if (g > 255) g = 255;
			else if (g < 0) g = 0;
			return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16);
		}

		function showMarkEditDialog(callbackSuccess, callbackFailure) {
			$("#markTable").css({
				"display": "flex",
				"opacity": 0
			});
			$("#markTable").animate({
				"opacity": 1
			}, 200);
			$("#mark-save-btn").off().click(() => {
				$("#markTable").animate({
					"opacity": 0
				}, 200, () => {
					$("#markTable").css({
						"display": "none"
					});
				});
				callbackSuccess();
			});
			/*
			$("#mark-cancel-btn").off("cancel-close").click(() => {
				$("#markTable").animate({
					"opacity": 0
				}, 200, () => {
					$("#markTable").css({
						"display": "none"
					});
				});
				callbackFailure();

			});
			*/
		}

		function showConfirmationDialog(callbackSuccess, callbackFailure) {
			$("#mainContentModal").css({
				"display": "flex",
				"opacity": 0
			});
			$("#mainContentModal").animate({
				"opacity": 1
			}, 200);
			$("#modal-confirm-btn").off().click(() => {
				$("#mainContentModal").animate({
					"opacity": 0
				}, 200, () => {
					$("#mainContentModal").css({
						"display": "none"
					});
				});
				callbackSuccess();
			});
			$("#modal-cancel-btn").off().click(() => {
				$("#mainContentModal").animate({
					"opacity": 0
				}, 200, () => {
					$("#mainContentModal").css({
						"display": "none"
					});
				});
				callbackFailure();
			});
		}

		function loadPageContent(menuListArrayIndex) {
			jsonContent = menuListContent[menuListArrayIndex];
			if (jsonContent != undefined) {
				if (screenUpdateInterval) {
					clearInterval(screenUpdateInterval);
				}
				fs.readFile(pt("content.json"), (err, data) => {
					data = JSON.parse(data);
					fs.readFile(pt("calendar.json"), (err, calendar) => {
						let cal = JSON.parse(calendar);
						let out = "";
						switch (jsonContent.title) {
							case 'Settings':
								out += "<div class='title'>" + jsonContent.title + "</div>";
								out += "<h1>Class List</h1>";
								out += "<table id='settings-classeslist'>";
								out += "<tr>" + "<th>Code</th>" + "<th>Name</th>" + "<th>Icon</th>" + "<th>Colour</th>" + "</tr>";
								for (let i = 0; i < data.classes.length; i++) {
									out += "<tr>" +
										"<td>" + data.classes[i].name + "</td>" +
										"<td>" + data.classes[i].title + "</td>" +
										"<td><input id='content-icon-" + data.classes[i].name + "' type='text' value='" + data.classes[i].icon + "' /></td>" +
										"<td style='color:" + ((parseInt(data.classes[i].color.substring(0, 2), 16) * 0.299 + parseInt(data.classes[i].color.substring(2, 4), 16) * 0.587 + parseInt(data.classes[i].color.substring(4, 6), 16) * 0.114) > 186 ? "#000000" :
											"#FFFFFF") +
										";background:#" + data.classes[i].color + ";display:flex;'><input style='flex:1;' onkeyup='$(this).parent().css({\"background\":$(this).val()});$(this).next().val($(this).val())' id='content-color-" + data.classes[i].name +
										"' type='text' value='#" + data.classes[i].color +
										"' /><input id='content-color-input-" + data.classes[i].name + "' style='width:100%;height:3em;flex:4;' onchange='$(this).prev().val($(this).val());$(this).parent().css({\"background\":$(this).val()});' type='color' value='#" +
										data.classes[i].color + "' /></td>" +
										"</tr>";
								}
								out += "</table>";
								out += "<button id='content-save-btn' class='right button'>Save Settings</button>";
								out += "<button id='content-randomColour-btn' class='right button'>Random Colours</button>";
								out += "<div class='line-break'></div>";
								out += "<button id='mycampus-update-btn' class='button'>Update Data from MyCampus</button><br /><br />";
								out += "<button id='exam-update-btn' class='button'>Get Personalized Exam Schedule</button><br /><br /><br /><br /><br /><br />";
								$("#pannel-content-wrapper").html(out);
								SettingsPageLoadEventRegister();
								break;
							case 'Calendar':
								out += "<div class='title'>" + jsonContent.title + "</div>";
								out += "<div id='calendar'></div>";
								$("#pannel-content-wrapper").html(out);
								CalendarPageLoadEventRegister();
								break;
							case 'Overview':
								screenUpdateInterval = setInterval(() => {
									loadPageContent(menuListArrayIndex);
								}, (1000 * 60));
								out += "<div class='title'>" + jsonContent.title + "</div>";
								out += "<div class='row-wrapper'>";
								out += "<div class='column' style='width:100%;padding:1em;'><div class='column-content'>";
								out += "<h1>Today's Classes:</h1>";
								let isTomorrowClass = false;
								var countDownsArr = [];
								let eventArr = [];
								for (let i = 0; i < cal.length; i++) {
									let now = new Date();
									let classT = new Date(cal[i].startTime);
									let classE = new Date(cal[i].endTime);
									if (now.toLocaleDateString() === classT.toLocaleDateString()) {
										isTomorrowClass = true;
										let co = data.classes[data.classes.findIndex(findCourse(cal[i].code))].color;
										let classCountHash = saltAndHash(cal[i].crn);
										let eventIcon = "book";
										for (let o = 0; o < data.classes.length; o++) {
											if (cal[i].code === data.classes[o].name) {
												eventIcon = data.classes[o].icon;
											}
										}
										eventArr.push({
											"id": "#event-" + classCountHash,
											"course": cal[i].code
										});
										out += "<div id='event-" + classCountHash + "' class='event " + (now.getTime() > classE.getTime() ? "strikeout" : "") + "' style='border-left: 7px solid #" + co + ";background:#" + colorFade(co, 180) + ";'>" +
											"<div class='event-content-wrapper'>" +
											"<p class='event-name'>" + cal[i].name + "</p>" +
											"<p class='event-location'>" + cal[i].type + " - " + cal[i].place + "</p>" +
											"<p class='event-time'>" + (new Date(cal[i].startTime)).toLocaleTimeString() + " - " + (new Date(cal[i].endTime)).toLocaleTimeString() + "</p>";
										if (now.getTime() < classE.getTime()) {
											out += "<div class='countd' id='" + classCountHash + "'><span id='" + classCountHash + "-text'></span></div>";
											countDownsArr.push({
												"container": classCountHash,
												"text": classCountHash + '-text',
												"time": (now.getTime() > cal[i].startTime ? cal[i].endTime : cal[i].startTime),
												"descriptor": (now.getTime() > cal[i].startTime ? "ends " : "")
											});
										}
										out += "</div>";
										out += "<div class='event-icon-wrapper'>";
										out += "<i style='font-size:3em;color:#" + co + ";' class='fa fa-" + eventIcon + "'></i>";
										out += "</div>";
										out += "</div>";
									}
								}
								if (!isTomorrowClass) {
									out += "<h2>No Class Scheduled</h2>";
								}
								out += "<div class='line-break'></div>";
								out += "<h1>Tomorrow's Classes:</h1>";
								isTomorrowClass = false;
								for (let i = 0; i < cal.length; i++) {
									let now = new Date();
									now.setTime(now.getTime() + (1000 * 60 * 60 * 24));
									let classT = new Date(cal[i].startTime);
									if (now.toLocaleDateString() === classT.toLocaleDateString()) {
										isTomorrowClass = true;
										let co = data.classes[data.classes.findIndex(findCourse(cal[i].code))].color;
										let classCountHash = saltAndHash(cal[i].crn);
										let eventIcon = "book";
										for (let o = 0; o < data.classes.length; o++) {
											if (cal[i].code === data.classes[o].name) {
												eventIcon = data.classes[o].icon;
											}
										}
										eventArr.push({
											"id": "#event-" + classCountHash,
											"course": cal[i].code
										});
										out += "<div id='event-" + classCountHash + "' class='event' style='border-left: 7px solid #" + co + ";background:#" + colorFade(co, 180) + ";'>" +
											"<div class='event-content-wrapper'>" +
											"<p class='event-name'>" + cal[i].name + "</p>" +
											"<p class='event-location'>" + cal[i].type + " - " + cal[i].place + "</p>" +
											"<p class='event-time'>" + (new Date(cal[i].startTime)).toLocaleTimeString() + " - " + (new Date(cal[i].endTime)).toLocaleTimeString() + "</p>" +
											"<div class='countd' id='" + classCountHash + "'><span id='" + classCountHash + "-text'></span></div>" +
											"</div>" +
											"<div class='event-icon-wrapper'>" +
											"<i style='font-size:3em;color:#" + co + ";' class='fa fa-" + eventIcon + "'></i>" +
											"</div>" +
											"</div>";
										countDownsArr.push({
											"container": classCountHash,
											"text": classCountHash + '-text',
											"time": cal[i].startTime
										});
									}
								}
								if (!isTomorrowClass) {
									out += "<h2>No Class Scheduled</h2>";
								}
								out += "</div></div>";
								out += "<div class='column'  style='width:100%;padding:1em;'><div class='column-content'>";
								out +=
									"<div class='row-wrapper' style='justify-content:space-between;align-items:center;'><h1>To-Do</h1><button id='overview-addtodo-btn' class='button'>New To-Do</button></div>";
								var list_todo = fs.readFileSync(pt("todo_list.json"));
								if (list_todo != "") {
									list_todo = JSON.parse(list_todo);
									list_todo.sort(sortTodoList);
								} else {
									list_todo = [];
								}
								var toDoArr = [];
								for (let i = 0; i < list_todo.length; i++) {
									let co = (list_todo[i].code === "other" ? "000000" : data.classes[data.classes.findIndex(findCourse(list_todo[i].code))].color);
									let todoID = list_todo[i];
									toDoArr.push(todoID);
									let dtodo = new Date(list_todo[i].date);
									out += "<div id=" + list_todo[i].id + " class='todo' style='border-left: 10px solid #" + co + ";background: #" + colorFade(co, 180) + "'>" +
										"<div class='row-wrapper'>" +
										"<div class='to-do-content-wrapper'>" +
										"<p class='todo-name'>" + list_todo[i].name + "</p>" +
										"<p class='todo-code'>" + ((list_todo[i].code === "other") ? list_todo[i].title : data.classes[data.classes.findIndex(findCourse(list_todo[i].code))].title) + "</p>" +
										"<p class='todo-date'>" + dtodo.toLocaleString() + "</p>" +
										"<div class='countd' id='" + list_todo[i].id + "'><span id='" + list_todo[i].id + "-text'></span></div>" +
										"</div>" +
										"<div class='to-do-icon-wrapper'><i class='fa' aria-hidden='true'></i></div>" +
										"</div>" +
										"<div id='" + list_todo[i].id + "' class='todo-progress'><div id='" + list_todo[i].id + "' class='todo-progress-bar'></div></div>" +
										"</div>";
									countDownsArr.push({
										"container": list_todo[i].id,
										"text": list_todo[i].id + '-text',
										"time": list_todo[i].date
									});
								}
								out += "</div></div>";
								out += "</div>";
								$("#pannel-content-wrapper").html(out);
								for (let i = 0; i < countDownsArr.length; i++) {
									let tObj = new Date(countDownsArr[i].time);
									let countStr = tObj.getFullYear() + "/" + (tObj.getMonth() + 1) + "/" + tObj.getDate() + " " + tObj.getHours() + ":" + tObj.getMinutes();
									$("#" + countDownsArr[i].container + ".countd").countdown(countStr, (event) => {
										if (parseInt(event.strftime('%D')) > 0) {
											$("#" + countDownsArr[i].text).html(event.strftime((countDownsArr[i].descriptor || "") + 'in %D day' + (parseInt(event.strftime('%D')) > 1 ? 's' : '') + ', %H hr' + (parseInt(event.strftime('%H')) > 1 ? 's' : '') + ', %M min' + (
												parseInt(
													event.strftime('%M')) > 1 ? 's' :
												'')));
										} else if (parseInt(event.strftime('%H')) > 0) {
											$("#" + countDownsArr[i].text).html(event.strftime((countDownsArr[i].descriptor || "") + 'in %H hr' + (parseInt(event.strftime('%H')) > 1 ? 's' : '') + ', %M min' + (parseInt(event.strftime('%M')) > 1 ? 's' : '')));
										} else {
											$("#" + countDownsArr[i].text).html(event.strftime((countDownsArr[i].descriptor || "") + 'in %M min' + (parseInt(event.strftime('%M')) > 1 ? 's' : '')));
										}
									});
								}
								for (let i = 0; i < toDoArr.length; i++) {
									moveProgressBar(toDoArr[i]);
									$("#" + toDoArr[i].id + ".todo").click(() => {
										showConfirmationDialog(() => {
											$("#" + toDoArr[i].id + ".todo").fadeOut();
											setTimeout(() => {
												$("#" + toDoArr[i].id + ".todo").remove();
												fs.readFile(pt("todo_list.json"), (err, ToDodata) => {
													ToDodata = JSON.parse(ToDodata);
													ToDodata.splice(ToDodata.findIndex(findTodoID(toDoArr[i].id)), 1);
													fs.writeFile(pt("todo_list.json"), JSON.stringify(ToDodata), (err) => {});
												});
											}, 1500);
										}, () => {
											//just do nothing
										});
									});
								}
								for (let i = 0; i < eventArr.length; i++) {
									let eventCodeIndex = 0;
									for (let j = 0; j < menuListContent.length; j++) {
										if (menuListContent[j].name != undefined) {
											if (menuListContent[j].name === eventArr[i].course) {
												eventCodeIndex = j;
											}
										}
									}
									$(eventArr[i].id).click(() => {
										loadPageContent(eventCodeIndex);
										for (let i = 0; i < jqMenuList.length; i++) {
											$(jqMenuList[i]).removeClass('active');
										}
										$(jqMenuList[eventCodeIndex]).addClass('active');
									});
								}
								OverviewPageLoadEventRegister();
								break;
							default:
								var countDownsArr = [];
								out += "<div class='title'>" + jsonContent.title + "</div>";
								out += "<div class='row-wrapper'>";
								out += "<div class='column' style='width:100%;padding:1em;'>" +
									"<div class='column-content'>";
								if (jsonContent.lecture) {
									out += "<h1>Lecture - " + jsonContent.lecture.crn + " - " + jsonContent.lecture.times[0].place + "</h1>";
								}
								if (jsonContent.tutorial) {
									out += "<div class='line-break'></div>";
									out += "<h1>Tutorial - " + jsonContent.tutorial.crn + " - " + jsonContent.tutorial.times[0].place + "</h1>";
								}
								if (jsonContent.lab) {
									out += "<div class='line-break'></div>";
									out += "<h1>Lab - " + jsonContent.lab.crn + " - " + jsonContent.lab.times[0].place + "</h1>";
								}
								out += "</div>";
								out += "<div class='column-content'>";
								out += "<h1>TEST</h1>";
								out += "<button id='edit-class-marks-btn' class='button' type='button'>Edit Marks</button>";
								out += "</div>"
								out += "</div>";
								out += "<div class='column' style='width:100%;padding:1em;'>" +
									"<div class='column-content'>";
								out +=
									"<div class='row-wrapper sticky-shim' style='justify-content:space-between;align-items:center;position:sticky;position:-webkit-sticky;top:50px;'><h1>To-Do</h1><button id='overview-addtodo-btn' class='button'>New To-Do</button></div>";
								var list_todo = fs.readFileSync(pt("todo_list.json"));
								if (list_todo != "") {
									list_todo = JSON.parse(list_todo);
									list_todo.sort(sortTodoList);
								} else {
									list_todo = [];
								}
								let courseSpecificTodo = [];
								for (let i = 0; i < list_todo.length; i++) {
									if (list_todo[i].code === jsonContent.name) {
										courseSpecificTodo.push(list_todo[i]);
									}
								}
								list_todo = courseSpecificTodo;
								var toDoArr = [];
								for (let i = 0; i < list_todo.length; i++) {
									let co = (list_todo[i].code === "other" ? "000000" : data.classes[data.classes.findIndex(findCourse(list_todo[i].code))].color);
									let todoID = list_todo[i];
									toDoArr.push(todoID);
									let dtodo = new Date(list_todo[i].date);
									out += "<div id=" + list_todo[i].id + " class='todo' style='border-left: 10px solid #" + co + ";background: #" + colorFade(co, 180) + "'>" +
										"<div class='row-wrapper'>" +
										"<div class='to-do-content-wrapper'>" +
										"<p class='todo-name'>" + list_todo[i].name + "</p>" +
										"<p class='todo-code'>" + ((list_todo[i].code === "other") ? list_todo[i].title : data.classes[data.classes.findIndex(findCourse(list_todo[i].code))].title) + "</p>" +
										"<p class='todo-date'>" + dtodo.toLocaleString() + "</p>" +
										"<div class='countd' id='" + list_todo[i].id + "'><span id='" + list_todo[i].id + "-text'></span></div>" +
										"</div>" +
										"<div class='to-do-icon-wrapper'><i class='fa' aria-hidden='true'></i></div>" +
										"</div>" +
										"<div id='" + list_todo[i].id + "' class='todo-progress'><div id='" + list_todo[i].id + "' class='todo-progress-bar'></div></div>" +
										"</div>";
									countDownsArr.push({
										"container": list_todo[i].id,
										"text": list_todo[i].id + '-text',
										"time": list_todo[i].date
									});
								}
								out += "</div>";
								out += "</div>";
								$("#pannel-content-wrapper").html(out);
								for (let i = 0; i < countDownsArr.length; i++) {
									let tObj = new Date(countDownsArr[i].time);
									let countStr = tObj.getFullYear() + "/" + (tObj.getMonth() + 1) + "/" + tObj.getDate() + " " + tObj.getHours() + ":" + tObj.getMinutes();
									$("#" + countDownsArr[i].container + ".countd").countdown(countStr, (event) => {
										if (parseInt(event.strftime('%D')) > 0) {
											$("#" + countDownsArr[i].text).html(event.strftime('in %D day' + (parseInt(event.strftime('%D')) > 1 ? 's' : '') + ', %H hr' + (parseInt(event.strftime('%H')) > 1 ? 's' : '') + ', %M min' + (parseInt(event.strftime('%M')) > 1 ?
												's' :
												'')));
										} else if (parseInt(event.strftime('%H')) > 0) {
											$("#" + countDownsArr[i].text).html(event.strftime('in %H hr' + (parseInt(event.strftime('%H')) > 1 ? 's' : '') + ', %M min' + (parseInt(event.strftime('%M')) > 1 ? 's' : '')));
										} else {
											$("#" + countDownsArr[i].text).html(event.strftime('in %M min' + (parseInt(event.strftime('%M')) > 1 ? 's' : '')));
										}
									});
								}
								for (let i = 0; i < toDoArr.length; i++) {
									moveProgressBar(toDoArr[i]);
									$("#" + toDoArr[i].id + ".todo").click(() => {
										showConfirmationDialog(() => {
											$("#" + toDoArr[i].id + ".todo").fadeOut();
											setTimeout(() => {
												$("#" + toDoArr[i].id + ".todo").remove();
												fs.readFile(pt("todo_list.json"), (err, ToDodata) => {
													ToDodata = JSON.parse(ToDodata);
													ToDodata.splice(ToDodata.findIndex(findTodoID(toDoArr[i].id)), 1);
													fs.writeFile(pt("todo_list.json"), JSON.stringify(ToDodata), (err) => {});
												});
											}, 1500);
										}, () => {
											//just do nothing
										});
									});
								}
								CoursePageLoadEventRegister(jsonContent.name);
								break;
						}
					});
				});
			}
		}

		function findCourseInTODO(courseid) {
			return (element) => {
				return element.code && element.code === courseid;
			};
		}

		function moveProgressBar(_x) {
			var interval = setInterval(() => {
				let _now = new Date();
				let _done = new Date(_x.date);
				let _start = new Date(_x.timeCreated);
				let perComplete = 100 - (Math.floor(((_now.getTime() - _start.getTime()) / ((_done.getTime() - _start.getTime() < 1 ? 1 : _done.getTime() - _start.getTime()))) * 1000) / 10);
				let str_perComplete = perComplete + "%";
				let str_roundPerComplete = Math.floor(perComplete) + "%";
				$("#" + _x.id + ".todo-progress-bar").css({
					"width": str_perComplete
				});
				if (perComplete <= 0) {
					perComplete = 0;
					clearInterval(interval);
					$("#" + _x.id + ">.row-wrapper>.to-do-icon-wrapper>i").className = '';
					$("#" + _x.id + ">.row-wrapper>.to-do-icon-wrapper>i").addClass('fa');
					$("#" + _x.id + ">.row-wrapper>.to-do-icon-wrapper>i").addClass('fa-exclamation-triangle');
					$("#" + _x.id + ">.row-wrapper>.to-do-icon-wrapper").css({
						"animation-name": "fadeinout",
						"animation-duration": "0.5s",
						"animation-direction": "alternate",
						"animation-iteration-count": "infinite",
						"animation-timing-function": "linear"
					});
					/*
					$("#" + _x.id + ">.row-wrapper>.to-do-icon-wrapper").css({
						"opacity": "1"
					});
					*/
				} else if (perComplete <= 10) {
					$("#" + _x.id + ">.row-wrapper>.to-do-icon-wrapper>i").className = '';
					$("#" + _x.id + ">.row-wrapper>.to-do-icon-wrapper>i").addClass('fa');
					$("#" + _x.id + ">.row-wrapper>.to-do-icon-wrapper>i").addClass('fa-clock-o');
					$("#" + _x.id + ">.row-wrapper>.to-do-icon-wrapper").css({
						"animation-name": "fadeinout",
						"animation-duration": "0.5s",
						"animation-direction": "alternate",
						"animation-iteration-count": "infinite",
						"animation-timing-function": "linear"
					});
				}
			}, 500);
		}

		function sortTodoList(a, b) {
			return a.date - b.date;
		}

		function findTodoID(id) {
			return function(element) {
				return element.id === id;
			};
		}

		function findCourse(course) {
			return function(element) {
				return element.name === course;
			};
		}

		function CalendarPageLoadEventRegister() {
			let calendarEvents = [];
			let filePath = "calendar.json";
			fs.readFile(pt(filePath), 'utf8', (err, data) => {
				let classData = fs.readFileSync(pt("content.json"), 'utf8');
				classData = JSON.parse(classData);
				data = JSON.parse(data);
				for (let i = 0; i < data.length; i++) {
					let index = classData.classes.findIndex(findCourse(data[i].code));
					let newCale = {
						title: data[i].name + " " + data[i].type,
						start: moment(data[i].startTime),
						end: moment(data[i].endTime),
						color: "#" + classData.classes[index].color
					}
					calendarEvents.push(newCale);
				}
				let todo_data = fs.readFileSync(pt("todo_list.json"), 'utf8');
				todo_data = JSON.parse(todo_data);
				for (let i = 0; i < todo_data.length; i++) {
					let fullItemCalColor = (todo_data[i].code === "other" ? "000000" : classData.classes[classData.classes.findIndex(findCourse(todo_data[i].code))].color);
					let newCale = {
						title: todo_data[i].name,
						start: moment(todo_data[i].date),
						color: "#" + fullItemCalColor,
						allDay: true
					}
					calendarEvents.push(newCale);
				}
				$('#calendar').fullCalendar({
					header: {
						left: 'prev, next today',
						center: 'title',
						right: ''
					},
					width: 'parent',
					height: 'parent',
					defaultView: 'agendaWeek',
					themeSystem: 'bootstrap3',
					nowIndicator: true,
					editable: false,
					events: calendarEvents,
					businessHours: {
						dow: [1, 2, 3, 4, 5],
						start: '8:00',
						end: '21:00',
					}
				});
			});

		}

		function OverviewPageLoadEventRegister() {
			document.getElementById("overview-addtodo-btn").addEventListener("click", (e) => {
				const BrowserWindow = remote.BrowserWindow;
				var win = new BrowserWindow({
					parent: remote.getCurrentWindow(),
					modal: true,
					width: 400,
					height: 650,
					minHeight: 650,
					minWidth: 400,
					maxHeight: 650,
					maxWidth: 400,
					frame: false
				});
				win.on('close', () => {
					remote.getCurrentWindow().show();
					remote.getCurrentWindow().focus();
					loadPageContent(0);
				});
				win.setMenu(null);
				win.loadURL(url.format({
					pathname: path.join(__dirname, '/addTodo.html'),
					protocol: 'file:',
					slashes: true
				}));
				win.once('ready-to-show', () => {
					win.show();
					win.focus();
				});
			});
		}

		function CoursePageLoadEventRegister(coursecode) {
			let filePath = "content.json";

			document.getElementById("edit-class-marks-btn").addEventListener("click", (e) => {
				showMarkEditDialog(() => {
					console.log("save");
				}, () => {
					console.log("cancel");
				});
			});

			document.getElementById("overview-addtodo-btn").addEventListener("click", (e) => {
				const BrowserWindow = remote.BrowserWindow;
				var win = new BrowserWindow({
					parent: remote.getCurrentWindow(),
					modal: true,
					width: 400,
					height: 650,
					minHeight: 650,
					minWidth: 400,
					maxHeight: 650,
					maxWidth: 400,
					frame: false
				});
				win.on('close', () => {
					remote.getCurrentWindow().show();
					remote.getCurrentWindow().focus();
					let eventCodeIndex = 0;
					for (let j = 0; j < menuListContent.length; j++) {
						if (menuListContent[j].name != undefined) {
							if (menuListContent[j].name === coursecode) {
								eventCodeIndex = j;
							}
						}
					}
					loadPageContent(eventCodeIndex);
				});
				win.setMenu(null);
				win.loadURL(url.format({
					pathname: path.join(__dirname, '/addTodo.html'),
					protocol: 'file:',
					slashes: true
				}));
				win.once('ready-to-show', () => {
					win.show();
					win.focus();
				});
			});
		}

		function loadSideBar(callback, pageIndex) {
			pageIndex = pageIndex || 0;
			let filePath = "content.json";
			jqMenuList = [];
			menuListContent = [];
			$(".left-pannel").html("");
			fs.readFile(pt(filePath), 'utf8', (err, data) => {
				data = JSON.parse(data);
				$(".window-title").text((data.userName && data.userName != "" ? data.userName + "'s Personal Dashboard" : "Personal Dashboard"));
				let classes = data.classes;
				let pages = data.pages;
				let stout = "";
				jqMenuList.push("#menu-overview");
				jqMenuList.push("#menu-calendar");
				menuListContent.push(pages[0]);
				menuListContent.push(pages[1]);
				for (let i = 0; i < classes.length; i++) {
					stout += '<div id="menu-' + classes[i].name + '" style="color:' + ((parseInt(classes[i].color.substring(0, 2), 16) * 0.299 + parseInt(classes[i].color.substring(2, 4), 16) * 0.587 + parseInt(classes[i].color.substring(4, 6), 16) * 0.114) >
						186 ?
						"#000000" : "#FFFFFF") + ';background:#' + classes[i].color + '" class="menu-item"><i class="fa fa-' + classes[i].icon + '" aria-hidden="true"></i><span>' + classes[i].name + '</span></div>';
					jqMenuList.push("#menu-" + classes[i].name);
					menuListContent.push(classes[i]);
				}
				stout = '<div id="menu-overview" class="menu-item"><i class="fa fa-home" aria-hidden="true"></i><span>Overview</span></div>' +
					'<div id="menu-calendar" class="menu-item"><i class="fa fa-calendar" aria-hidden="true"></i><span>Calendar</span></div>' + stout;
				stout += '<div id="menu-settings" class="menu-item"><i class="fa fa-cog" aria-hidden="true"></i><span>Settings</span></div>';
				$(".left-pannel").html(stout);
				jqMenuList.push("#menu-settings");
				menuListContent.push(pages[2]);
				loadPageContent(pageIndex);
				for (let i = 0; i < jqMenuList.length; i++) {
					$(jqMenuList[i]).click(() => {
						loadPageContent(i);
						for (let i = 0; i < jqMenuList.length; i++) {
							$(jqMenuList[i]).removeClass('active');
						}
						$(jqMenuList[i]).addClass('active');
					});
				}
				$(jqMenuList[0]).addClass('active');
				callback();
			});
		}

		function startTime() {
			var timeObject = setInterval(() => {
				let d = new Date();
				let cl = (d.getHours() < 10 ? "0" : "") + d.getHours() + ":" + (d.getMinutes() < 10 ? "0" : "") + d.getMinutes() + ":" + (d.getSeconds() < 10 ? "0" : "") + d.getSeconds();
				$("#time").html(cl);
			}, 100);

		}

		function findCourseType(courseType, courseID) {
			return function(element) {
				return element.type === courseType && element.code === courseID;
			}
		}

		function SettingsPageLoadEventRegister() {
			document.getElementById('content-save-btn').addEventListener("click", (e) => {
				let cont = JSON.parse(fs.readFileSync(pt("content.json"), 'utf8'));
				for (let i = 0; i < cont.classes.length; i++) {
					cont.classes[i].icon = $("#content-icon-" + cont.classes[i].name).val();
					cont.classes[i].color = $("#content-color-" + cont.classes[i].name).val().split("#")[1];
				}
				fs.writeFileSync(pt("content.json"), JSON.stringify(cont));
				loadSideBar(() => {});
			});

			document.getElementById('content-randomColour-btn').addEventListener("click", (e) => {
				let cont = JSON.parse(fs.readFileSync(pt("content.json"), 'utf8'));
				for (let i = 0; i < cont.classes.length; i++) {
					let ranColour = randomHexColour();
					let textColour = ((parseInt(ranColour.substring(0, 2), 16) * 0.299 + parseInt(ranColour.substring(2, 4), 16) * 0.587 + parseInt(ranColour.substring(4, 6), 16) * 0.114) > 186 ? "#000000" : "#FFFFFF");
					$("#content-color-" + cont.classes[i].name).parent().css({
						"background": "#" + ranColour,
						"color": textColour
					});
					$("#content-color-" + cont.classes[i].name).val("#" + ranColour);
					$("#content-color-" + cont.classes[i].name).css({
						"color": textColour
					});
					$("#content-color-input-" + cont.classes[i].name).val("#" + ranColour);
					$("#content-color-input-" + cont.classes[i].name).css({
						"color": textColour
					});
				}
			});

			document.getElementById("exam-update-btn").addEventListener("click", (e) => {
				const BrowserWindow = remote.BrowserWindow;
				var win = new BrowserWindow({
					parent: remote.getCurrentWindow(),
					modal: true,
					width: 400,
					height: 400,
					minHeight: 400,
					minWidth: 400,
					maxHeight: 400,
					maxWidth: 400,
					frame: false
				});
				win.on('close', () => {
					remote.getCurrentWindow().show();
					remote.getCurrentWindow().focus();
					loadSideBar(() => {});
					loadPageContent(0);
				});
				win.setMenu(null);
				win.loadURL(url.format({
					pathname: path.join(__dirname, '/exam_login.html'),
					protocol: 'file:',
					slashes: true
				}));
				win.once('ready-to-show', () => {
					win.show();
					win.focus();
				});
			});

			document.getElementById("mycampus-update-btn").addEventListener("click", (e) => {
				const BrowserWindow = remote.BrowserWindow;
				var win = new BrowserWindow({
					parent: remote.getCurrentWindow(),
					modal: true,
					width: 400,
					height: 400,
					minHeight: 400,
					minWidth: 400,
					maxHeight: 400,
					maxWidth: 400,
					frame: false
				});
				win.on('close', () => {
					remote.getCurrentWindow().show();
					remote.getCurrentWindow().focus();
					loadSideBar(() => {});
					loadPageContent(0);
				});
				win.setMenu(null);
				win.loadURL(url.format({
					pathname: path.join(__dirname, '/login.html'),
					protocol: 'file:',
					slashes: true
				}));
				win.once('ready-to-show', () => {
					win.show();
					win.focus();
				});
			});
		}

		function pt(_pa) {
			return path.join(remote.getGlobal('APDD'), _pa);
		}

		function init() {
			console.log(remote.getGlobal('APDD'));
			fs.stat(pt("content.json"), (err, stat) => {
				if (err && err.code == 'ENOENT') {
					mkdirp.sync(remote.getGlobal('APDD'));
					let writeContent = '{"userName":"","pages": [{"title": "Overview"}, {"title": "Calendar"}, {"title": "Settings"}],"classes": []}';
					fs.writeFileSync(pt('content.json'), writeContent);
					fs.writeFileSync(pt('calendar.json'), "[]");
					fs.writeFileSync(pt('todo_list.json'), "[]");
					const BrowserWindow = remote.BrowserWindow;
					var win = new BrowserWindow({
						parent: remote.getCurrentWindow(),
						modal: true,
						width: 400,
						height: 400,
						minHeight: 400,
						minWidth: 400,
						maxHeight: 400,
						maxWidth: 400,
						frame: false
					});
					win.on('close', () => {
						remote.getCurrentWindow().show();
						remote.getCurrentWindow().focus();
						loadSideBar(() => {});
						loadPageContent(0);
					});
					win.setMenu(null);
					win.loadURL(url.format({
						pathname: path.join(__dirname, '/login.html'),
						protocol: 'file:',
						slashes: true
					}));
					win.once('ready-to-show', () => {
						win.show();
						win.focus();
					});
				}

				loadSideBar(() => {
					startTime();

					document.getElementById("min-btn").addEventListener("click", (e) => {
						const window = remote.getCurrentWindow();
						window.minimize();
					});
					let max_state = false;
					document.getElementById("max-btn").addEventListener("click", (e) => {
						const window = remote.getCurrentWindow();
						if (!max_state) {
							window.maximize();
							max_state = true;
						} else {
							window.unmaximize();
							max_state = false;
						}
					});

					document.getElementById("close-btn").addEventListener("click", (e) => {
						const window = remote.getCurrentWindow();
						window.close();
					});

					if (dev) {
						document.getElementById("dev-btn").classList.remove("hidden");
						document.getElementById("dev-btn").addEventListener("click", (e) => {
							const win = remote.getCurrentWindow();
							win.webContents.openDevTools();
						});
					} else {
						document.getElementById("dev-btn").classList.add("hidden");
					}

					document.getElementById("full-btn").addEventListener("click", (e) => {
						const BrowserWindow = remote.BrowserWindow;
						var win = new BrowserWindow({
							width: 800,
							height: 600,
							frame: false
						});
						win.setMenu(null);
						win.show();
						win.focus();
						win.loadURL(url.format({
							pathname: path.join(__dirname, '/window.html'),
							protocol: 'file:',
							slashes: true
						}));
					});
				});
			});
		};

		function randomHexColour() {
			var letters = '0123456789ABCDEF'.split('');
			var color = '';
			for (var i = 0; i < 6; i++) {
				color += letters[Math.round(Math.random() * 15)];
			}
			return color;
		}

		var saltLength = 5;
		var generateSalt = function() {
			var set = '0123456789abcdefghijklmnopqurstuvwxyzABCDEFGHIJKLMNOPQURSTUVWXYZ';
			var salt = '';
			for (var i = 0; i < saltLength; i++) {
				var p = Math.floor(Math.random() * set.length);
				salt += set[p];
			}
			return salt;
		};
		var hash = function(str) {
			return crypto.createHash('md5').update(str).digest('HEX');
		};
		var saltAndHash = function(pass) {
			var salt = generateSalt();
			return salt + hash(pass + salt) + hash(salt);
		};

		document.onreadystatechange = () => {
			if (document.readyState == "complete") {
				const win = remote.getCurrentWindow();
				if (dev) {
					win.webContents.openDevTools();
				}
				init();
			}
		};
	</script>
</body>

</html>
